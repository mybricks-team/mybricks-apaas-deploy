!function(n,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["@fangzhou/compiler-js"]=t():n["@fangzhou/compiler-js"]=t()}(this,(function(){return function(n){var t={};function e(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return n[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=n,e.c=t,e.d=function(n,t,o){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:o})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var o=Object.create(null);if(e.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var i in n)e.d(o,i,function(t){return n[t]}.bind(null,i));return o},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},e.p="",e(e.s=1)}([function(n){n.exports=JSON.parse('{"name":"@fangzhou/compiler-js","version":"0.0.15","main":"dist/index.min.js","scripts":{"test":"jest","build":"webpack --config build/webpack.config.js"},"author":"CheMingjun","license":"MIT","repository":{"type":"git","url":"https://git.corp.kuaishou.com/plateco-dev/kwaishop-power/paas/fangzhou-compiler-js.git"},"devDependencies":{"@types/jest":"^25.1.1","@types/node":"^13.9.0","jest":"^26.0.1","ts-jest":"^26.1.0","ts-loader":"^8.2.0","webpack":"^4.42.0","webpack-bundle-analyzer":"^3.6.1","webpack-cli":"^3.3.11"}}')},function(n,t,e){"use strict";var o;e.r(t),e.d(t,"T_Scope",(function(){})),e.d(t,"FRAME_LABEL_DEFAULT",(function(){return r})),e.d(t,"compile",(function(){return v})),e.d(t,"createIO",(function(){return b})),e.d(t,"E_ItemType",(function(){return o})),e.d(t,"I_Frame",(function(){})),e.d(t,"T_PinDirection",(function(){})),e.d(t,"I_Joint",(function(){})),e.d(t,"I_Node",(function(){})),e.d(t,"I_Pin",(function(){})),e.d(t,"I_Runner",(function(){})),e.d(t,"isTypeof",(function(){return u})),e.d(t,"UNDEFINED_FRAME_LABEL",(function(){})),function(n){n[n.FRAME=0]="FRAME",n[n.NODE=1]="NODE",n[n.PIN=2]="PIN",n[n.JOINT=3]="JOINT",n[n.CONNECTION=4]="CONNECTION"}(o||(o={}));var i=e(0);const r="default";function u(n,t){return n&&"object"==typeof n&&n._type==t}function s(){let n="abcdefhijkmnprstwxyz",t=n.length,e="";for(let o=0;o<6;o++)e+=n.charAt(Math.floor(Math.random()*t));return"u_"+e}var c;function f(n,t,e="runtime"){let i=n;"object"!=typeof i||i._exe||(i._exe=function(e,r,s,c){if(n.isBlocked)return;if(!m())return;if(!n.finishPin)return;const f=n.finishPin.forkedFrom||n.finishPin;if("function"==typeof f._exe)x.debug&&x.debug.stepTime,f._exe(e,r,s,i);else{const e=u(n.startPin.parent,o.NODE)?n.startPin.parent:void 0;t.onError({type:"con",id:n.id},`连接(来自:${e?e.title:"未知组件"}，${i.title})未实现.`)}})}function p(n,t,e="runtime"){n.conAry&&n.conAry.forEach(n=>{f(n,t)}),n.forkedAsJoint&&p(n.forkedAsJoint,t,e),n._exe=function(i,r,s,c){if(!m())return;I.execute&&I.execute(o.PIN,n.id,r);let f=i,p=t.pin?t.pin(n):void 0;if(p){if(!1===p.exe(r,c,i))return}const a=t=>{p&&p.exe(t,n,"返回"),"function"==typeof s&&s(t)},d=n;if("config"==d.direction)n.parent._config(f,{id:d.hostId,value:r,binding:d.extBinding});else if("input"==d.direction)if(n.proxyPin){const t=n.proxyPin;if(u(t.parent,o.FRAME))if("inner-output"===t.direction){const e=t.parent;if("function"==typeof e._exe){const t={};if(u(n.parent,o.NODE)){const o=n.parent;o.outputPins&&o.outputPins.forEach(n=>{n.proxyForPin&&e.outputPins&&e.outputPins.find(e=>{e.hostId===n.hostId&&(t[e.id]=n)})}),o.outputPinsInModel&&o.outputPinsInModel.forEach(n=>{n.proxyForPin&&e.outputPins&&e.outputPins.find(e=>{e.hostId===n.hostId&&(t[e.id]=n)})})}let i,s;e.parent?(i=n.id,s=e.parent._curScope_):(i=n.parent.id,s=f),e._exe(s,{[n.proxyPin.hostId]:r},i,n.direction,!1,t,f)}}else t._exe(f,r,a)}else n.parent._exe(f,{[n.hostId]:r},a,c);else if("inner-input"===n.direction){if(n._proxyForFn)return void n._proxyForFn(r);if(n.proxyPin)n.proxyPin._exe(f.parent,r,a,c);else if(n.emitPinAry)n.emitPinAry.forEach(n=>{n.parent.id===i.label&&n._exe(f.parent,r,a,c)});else if(n.forkedAsJoint)n.forkedAsJoint.conAry&&n.forkedAsJoint._exe(f.parent,r,a,c);else if(f.proxyForOutPins){const t=f.proxyForOutPins[n.id];t&&t._exe(f.from,r,a,c)}}else"output"!=n.direction&&"inner-output"!=n.direction||Promise.resolve().then(()=>{if(n.proxyPin)n.proxyPin._exe(f.parent,r,a,c);else{let t;"mock"===e&&n.mockData&&(t=n.mockData),n.conAry&&n.conAry.length>0&&n.conAry.forEach((e,o)=>{let i;a&&(void 0!==t?a(JSON.parse(n.mockData)):i=function(n){a(n)}),e&&"function"==typeof e._exe&&e._exe(f,r,i,n)})}})}}function a(n,t,e="runtime"){c.each(n=>p(n,t,e),n.configPins),c.each(n=>p(n,t,e),n.inputPins,n.inputPinExts,n.inputPinsInModel),c.each(n=>p(n,t,e),n.outputPins,n.inputPinExts,n.outputPinsInModel);const o=n,i=t.node(n),u={};function s(t){if("function"!=typeof i.render)throw new Error("Render config function for node not found.");const e={};n.frames&&n.frames.forEach(n=>{e[n.id]=function(e,o=r){const i=n._exe(t,e,o);if(i)return i.path}});const o=i.render(e,t);t.comInsts[n.id]={inst:o,scopes:[]},u[t.id]=!0}o._config=function(e,o){if(u[e.id]||(s(e),u[e.id]=!0),o){const i=o.binding,r=o.value;if(i){const t=n.model;if(t){const n=i.split(".");let e=t;n.forEach((t,o)=>{o!==n.length-1?e=e[t]:e[t]=r})}}else{let i,r=!0;if(u[e.id]||(n.parent&&e.parent&&n.parent.id!==e.frameId?(i=e.parent.comInsts[n.id],r=!1):s(e)),r&&!i&&(i=e.comInsts[n.id]),!i)return void t.onError({type:"node",id:n.id},new Error("Scope error."));try{i.inst.configs[o.id]=o.value}catch(e){"function"==typeof t.onError&&t.onError({type:"node",id:n.id},e)}}}},o._exe=function(e,o,r,f){let p;c.each(n=>{void 0!==n.dummyData&&(!p&&(p={}),p[n.hostId]=n.dummyData)},n.inputPins,n.inputPinsInModel),o=p?Object.assign(p,o):o;let a,d=!0;if(u[e.id]||(n.parent&&e.parent&&n.parent.id!==e.frameId?(a=e.parent.comInsts[n.id],a||(s(e.parent),a=e.parent.comInsts[n.id]),d=!1):s(e)),d&&!a&&(a=e.comInsts[n.id]),a){if(o)for(let i in o){const u=o[i];try{const o=new Proxy({},{get(o,i,u){if(f&&f.finishPin.rels){let o;return f.finishPin.rels.find(u=>{u===i&&(o=o=>{const u=c.find(n=>n.hostId===i,n.outputPinsInModel,n.outputPins);u&&u.conAry&&u.conAry.find(n=>{if(n.finishPin&&n.startPinParentKey===f.finishPinParentKey){let i=t.pin?t.pin(n.startPin):void 0;i&&i.exe(o,void 0),n.finishPin._exe(e,o,r,n)}})})}),o}}});a.inst.inputs[i]=[u,r,o]}catch(e){"function"==typeof t.onError&&t.onError({type:"node",id:n.id},e)}}i.exe&&i.exe(a.inst,o,r)}else t.onError({type:"node",id:n.id},new Error("Scope error."))},n.frames&&n.frames.forEach(n=>{l(n,t)})}!function(n){n.each=function(n,...t){t.forEach(t=>{t&&t.forEach(n)})},n.find=function(n,...t){let e;return t.find(t=>{if(t)return e=t.find(t=>n(t))}),e}}(c||(c={}));let d=new WeakMap;function l(n,t,e="runtime"){n.frameAry&&n.frameAry.forEach(n=>{l(n,t,e)}),n.comAry&&n.comAry.forEach(n=>{a(n,t,e)}),n.inputPins&&n.inputPins.forEach(n=>p(n,t,e)),n.outputPins&&n.outputPins.forEach(n=>p(n,t,e)),n.inputJoints&&n.inputJoints.forEach(n=>p(n,t,e)),n.outputJoints&&n.outputJoints.forEach(n=>p(n,t,e));const o=n,i={};o._update=function(o,u,s=r){const c=s+o.id,{curScope:f,coms:p}=i[c];n.comAry.forEach(n=>{p.push(n.id),"function"!=typeof n._exe&&(a(n,t,e),n._exe(f))})},o._exe=function(u,s,c=r,f,p,l,y){n.parent||(p=!0),u||(n.parent,u=t._scopeManager.applyScope(void 0,n.id,"-parent"));const h=c+u.id;let P=!1;if(i[h]){const t=i[h].coms;(t.length!==n.comAry.length||n.comAry.find(n=>t.indexOf(n.id)<0))&&(P=!0)}if(!i[h]||P){let r,s;if(o._exeAsRoot_=!!p,o._exeAsRoot_)r={inst:void 0,scopes:[]};else if(r=u.comInsts[n.parent.id],!r&&n._rootF)return;const d=[];if("input"==(f="string"==typeof f?f:"input")){const i=!o._exeAsRoot_&&n.parent?n.parent.id:void 0;s=u.applyScope(i,n.id,c,l,n._rootF,y),o._curScope_=s,n.comAry.forEach(n=>{d.push(n.id),"function"!=typeof n._exe&&a(n,t,e),n._autoRun&&n._exe(s)})}i[h]={myInstScope:r,curScope:s,coms:d}}const{curScope:_}=i[h];if("input"==(f="string"==typeof f?f:"input")){const t={};if("mock"===e&&n.inputPins.length>0&&n.inputPins.forEach(n=>{n.mockData&&(t[n.hostId]=n.mockData)}),s=Object.assign(t,s))for(let t in s){const e=n.inputPins.find(n=>n.hostId==t);e?e._exe(_,s[t],void 0,void 0):"undefined"!=typeof console&&"function"==typeof console.error&&console.error(`No inputPin(id=${t}) found`)}return n.inputJoints&&n.inputJoints.forEach(n=>{!function(n,t){let e=t.parent,o=d.get(n);if(o){let n=o.get(e);n&&n.forEach(n=>{n(t)})}}(n,_)}),_}if(f.match(/^(output)|(inner-input)$/gi)){let t=_;if(n.outputPins.length){if(s)for(let n in s)t.returnParams[n]=s[n]||null;n.outputPins.find(n=>null==t.returnParams[n.hostId])||t.resolve()}}}}function y(){let n;return{applyScope:(n,t,e)=>function n(t,e,o,i,r,u,c){const f={id:s(),instId:e,frameId:o,label:i,path:void 0,parent:t,from:c,proxyForOutPins:r,returnParams:{},resolve:null,comInsts:{},applyScope(t,e,o,i,r,u){const s=n(f,t,e,o,i,r,u);let c=f.comInsts[t];return c&&(!c.scopes&&(c.scopes=[]),c.scopes.push(s)),s}};if(u)f.path=f.id;else{const n=[f.id];let t=f.parent;for(;t;)t.parent&&n.push(t.id),t=t.parent;f.path=n.reverse().join(":")}return f}(void 0,n,t,e,void 0),start(){n={}},stop(){n={}}}}let h,P,_=null;let g="stop";function m(){return"running"===g}let x={},I={};function v(n,t,e="runtime"){return function(n,t){if(!u(n,t))throw new Error("Invalid item type")}(n,o.FRAME),l(n,t,e),_={on(n,t){n&&"string"==typeof n&&"function"==typeof t&&(I[n.toLowerCase()]=t)},run(e=n,o){if(t._scopeManager=y(),t._scopeManager.start(),function(n){return Object.assign(x,n||{}),h=[],P=[],!0}(o))return g="running",new Promise((n,t)=>{}),n=>{n&&n.outputs&&e.outputPins&&e.outputPins.forEach(t=>{const e=n.outputs[t.id];"function"==typeof e&&(t.proxyPin={_exe(n,t,o,i){e(t)}})});const t=e._exe(void 0,null==n?void 0:n.inputParams,void 0,"input",!0);return n.inputs&&e.inputPins&&Object.keys(n.inputs).forEach(o=>{const i=n.inputs[o],r=e.inputPins.find(n=>n.hostId===o);r&&r.conAry&&r.conAry.length>0&&i(n=>{r._exe(t,n,void 0,void 0)})}),t}},update:(t,e=n)=>(e._update(t,void 0,void 0),!0),pause:w,stop(){const n=(g="stop",!0);return _=null,h=void 0,P=void 0,t._scopeManager.stop(),t._scopeManager=void 0,n}}}function w(){return g="pause",!0}const E="__id__";function b(n,t,e){const o=s(),i=function({node:n,uid:t,ioProxy:e}){const o={};return new Proxy({},{ownKeys(t){const e=[];return c.each(n=>{e.push(n.hostId)},n.configPins),e},getOwnPropertyDescriptor:n=>({enumerable:!0,configurable:!0}),get:(n,e,i)=>e===E?t:function(n){o[e]=n},set(n,t,e,i){const r=o[t];return"function"==typeof r&&r(e),!0}})}({node:n,uid:o,ioProxy:t}),{_inputs:r,_inputsCallable:u}=A({node:n,uid:o,ioProxy:t}),{inputs:f,inputsCallable:p}=function({node:n,uid:t,ioProxy:e}){class o{constructor(...n){this._values=n}getVal(n){return this._values[n]}}const i={_all:{},_waiting:{},has(n){return"function"==typeof this._all[n]},set(n,t,e){let o=this._all[n];o||(o=this._all[n]=[]);let i=e||n;const r=o.find(n=>n.id===i);r?r.fn=t:o.push({id:i,fn:t});const u=this._waiting[n];if(u)try{u.forEach(n=>{n(o)}),delete this._waiting[n]}finally{}return!0},get(n){return this._all[n]},waiting(n,t){let e=this._waiting[n];e||(e=this._waiting[n]=[]),e.push(t)}},r=new Proxy({},{ownKeys(t){const e=[];return c.each(n=>{e.push(n.hostId)},n.inputPins,n.inputPinsInModel),e},getOwnPropertyDescriptor:n=>({enumerable:!0,configurable:!0}),get:(n,e,o)=>e===E?t:"_setInterseptor"===e?n[e]:function(n,t){let o;if(t)if("object"==typeof t){const o=t[e];"function"==typeof o&&o(n)}else"string"==typeof t&&(o=t);i.set(e,(function(e){if(void 0!==e){const[o,i,r]=e;let u;u="function"==typeof r?r("string"==typeof t?t:void 0):r,n(o,u)}}),o)},set(n,t,r,u){const s=n=>t=>{(null==e?void 0:e.input)&&e.input();t.forEach((t,e)=>{try{t.fn((t=>n[0]instanceof o?[n[0].getVal(t),n[1],n[2]]:n)(e))}catch(n){console.error(n)}})},c=i.get(t);return c?s(r)(c):i.waiting(t,s(r)),!0}}),u=new Proxy({},{get(t,e){const i=n.inputPins.find(({hostId:n})=>e==n);if(i)return function(n){let t;if(t=arguments.length>1?new o(...arguments):n,i.rels){const n={},o={};return i.rels.forEach(t=>{n[t]=n=>{o[t]=n}}),Promise.resolve().then(()=>{r[e]=[t,void 0,n=>{const t={};return i.rels.forEach(e=>{t[e]=t=>{o[e](t,n)}}),t}]}),n}r[e]=[t,void 0,void 0]}}});return{inputs:r,inputsCallable:u}}({node:n,uid:o,ioProxy:t}),a=function({node:n,uid:t,curScope:e}){return new Proxy({},{ownKeys(t){const e=[];return c.each(n=>{e.push(n.hostId)},n._outputPins),e},getOwnPropertyDescriptor:n=>({enumerable:!0,configurable:!0}),get(o,i,r){if(i===E)return t;if("_setInterseptor"===i)return o[i];if(n.outputPins||n.outputPinsInModel){const t=c.find(({hostId:n})=>i==n,n._outputPins);if(t){let o;return function(i,r,u){o=r;t._exe(e,i,(function(n){"function"==typeof o&&o(n)}),n)}}}}})}({node:n,uid:o,curScope:e}),d=function({node:n,uid:t,ioProxy:e,curScope:o}){return new Proxy({},{ownKeys(t){const e=[];return c.each(n=>{e.push(n.hostId)},n.outputPins,n.outputPinsInModel),e},getOwnPropertyDescriptor:n=>({enumerable:!0,configurable:!0}),get(i,r,u){if(r===E)return t;if("_setInterseptor"===r)return i[r];if(n.outputPins||n.outputPinsInModel){const t=c.find(({hostId:n})=>r==n,n.outputPins,n.outputPinsInModel);if(t){let i;return function(u,s,c){i=s;if((null==e?void 0:e.output)&&e.output(u),c){const n=c[r];"function"==typeof n&&n(u)}let f;if(t.runInFrameId){const e=o.comInsts[n.id].scopes;if(e&&(f=e.find(n=>n.frameId===t.runInFrameId)),!f)throw new Error("Scope not found for output.runInFrameId.")}else f=o;t._exe(f,u,(function(n){"function"==typeof i&&i(n)}),n)}}}}})}({node:n,uid:o,ioProxy:t,curScope:e});return{configs:i,_inputs:r,_inputsCallable:u,inputs:f,inputsCallable:p,_outputs:a,outputs:d,fork:(n,t,e)=>n&&"_inputs"===n.toLowerCase()?new Proxy(r,{get(n,e){const o=n[e];if("function"==typeof o)return n=>{o(n,t)}}}):n&&"inputs"===n.toLowerCase()?new Proxy(f,{get(n,o){const i=n[o];if("function"==typeof i)return t?n=>{i(n,t)}:"string"==typeof e?n=>{i(n,e)}:i}}):n&&"_outputs"===n.toLowerCase()?new Proxy(a,{get(n,e){const o=n[e];if("function"==typeof o)return(n,e)=>{o(n,e,t)}}}):n&&"outputs"===n.toLowerCase()?new Proxy(d,{get(n,e){const o=n[e];if("function"==typeof o)return(n,e)=>{o(n,e,t)}}}):void 0}}function A({node:n,uid:t,ioProxy:e}){const o={},i={_all:{},_waiting:{},has(n){return"function"==typeof this._all[n]},set(n,t){this._all[n]=t;const e=this._waiting[n];if(e)try{e.forEach(n=>{t(n)}),delete this._waiting[n]}finally{}return!0},get(n){return this._all[n]},waiting(n,t){let e=this._waiting[n];e||(e=this._waiting[n]=[]),e.push(t)}};return{_inputs:new Proxy({},{ownKeys(t){const e=[];return c.each(n=>{e.push(n.hostId)},n._inputPins),e},getOwnPropertyDescriptor:n=>({enumerable:!0,configurable:!0}),get:(n,e,r)=>e===E?t:"_setInterseptor"===e?n[e]:function(n){i.set(e,(function(t){const i=o[e];if(void 0!==t&&i){o[e]=void 0;const[i,r,u]=t;n(i,u)}}))},set(n,t,e,r){o[t]=e;const u=i.get(t);return u?u(e):i.waiting(t,e),!0}}),_inputsCallable:new Proxy({},{get(t,e){const o=n._inputPins.find(({hostId:n})=>e==n);if(o)return function(n){if(o.rels){const t={},i={},r={};return o.rels.forEach(n=>{i[n]=t=>{r[n](t)},t[n]=t=>{r[n]=t}}),Promise.resolve().then(()=>{inputs[e]=[n,void 0,i]}),t}inputs[e]=[n,void 0,void 0]}}})}}console.log(`%c ${i.name} %c@${i.version}`,"color:#FFF;background:#fa6400","","")}])}));